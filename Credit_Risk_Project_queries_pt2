### TASK 7 : Are there any factors in the application table affecting the Payment Difficulties? ###

#TO ANALYZE IF THE OCCUPATION TYPE HAS AFFECTED THEIR PAYMENT DIFFICULTIES

SELECT TARGET, 
	COUNT(TARGET) AS NUM_OF_CLIENTS, 
	OCCUPATION_TYPE 
FROM application
GROUP BY TARGET, OCCUPATION_TYPE
ORDER BY 
	OCCUPATION_TYPE ASC,
	NUM_OF_CLIENTS DESC
	
  
#TO ANALYZE IF HAVING REALTY AN CARS AFFECTS THE CLIENTS' PAYMENT DIFFICULTIES

SELECT FLAG_OWN_REALTY, TARGET, COUNT(TARGET) AS NUM_OF_CLIENT 
FROM application
GROUP BY TARGET, FLAG_OWN_REALTY 
ORDER BY
	FLAG_OWN_REALTY DESC,
	NUM_OF_CLIENT DESC
	
SELECT FLAG_OWN_CAR, TARGET, COUNT(TARGET) AS NUM_OF_CLIENT
FROM application
GROUP BY TARGET, FLAG_OWN_CAR 
ORDER BY 
	FLAG_OWN_CAR DESC,
	NUM_OF_CLIENT DESC

	
#TO ANALYZE IF THE AMT_INCOME AFFECTS THE CLIENTS' PAYMENT DIFFICULTIES
	
SELECT
CASE
	WHEN AMT_INCOME_TOTAL <= 50000 THEN "50K AND BELOW"
	WHEN AMT_INCOME_TOTAL > 50000 and AMT_INCOME_TOTAL <= 100000 THEN "50K TO 100K"
	WHEN AMT_INCOME_TOTAL > 100000 and AMT_INCOME_TOTAL <= 150000 THEN "100K TO 150K"
	WHEN AMT_INCOME_TOTAL > 150000 and AMT_INCOME_TOTAL <= 200000 THEN "150K TO 200K"
	WHEN AMT_INCOME_TOTAL > 200000 AND AMT_INCOME_TOTAL <= 250000 THEN "200K TO 250K"
	WHEN AMT_INCOME_TOTAL > 250000 AND AMT_INCOME_TOTAL <= 300000 THEN "250K TO 300K"
	WHEN AMT_INCOME_TOTAL > 300000 AND AMT_INCOME_TOTAL <= 350000 THEN "300K TO 350K"
	WHEN AMT_INCOME_TOTAL > 350000 AND AMT_INCOME_TOTAL <= 400000 THEN "350K TO 400K"
	WHEN AMT_INCOME_TOTAL > 400000 AND AMT_INCOME_TOTAL <= 450000 THEN "400K TO 450K"
	WHEN AMT_INCOME_TOTAL > 450000 AND AMT_INCOME_TOTAL <= 500000 THEN "450K TO 500K"
	WHEN AMT_INCOME_TOTAL > 500000 THEN "MORE THAN 500K"
END AS "INCOME_CLASS",
	TARGET, 
	COUNT(TARGET) AS "NUM_OF_CLIENT"
FROM application
GROUP BY INCOME_CLASS, TARGET
ORDER BY INCOME_CLASS


# TO ANALYZE IF THE INCOME_TYPE HAS SIGNIFICANT EFFECT ON PAYMENT DIFFICULTIES.

SELECT 
	NAME_INCOME_TYPE, 
	TARGET, 
	COUNT(TARGET) AS 'NUM_OF_CLIENTS'
FROM application
GROUP BY 
	NAME_INCOME_TYPE, TARGET 
ORDER BY 
	NAME_INCOME_TYPE ASC, NUM_OF_CLIENTS DESC  

SELECT NAME_INCOME_TYPE, TARGET 
FROM application
WHERE NAME_INCOME_TYPE = 'Maternity Leave'


# TO ANALYZE IF THE EDUCATION_TYPE HAS SIGNIFICANT EFFECT ON PAYMENT_DIFFICULTIES

SELECT 
	NAME_EDUCATION_TYPE, 
	TARGET, 
	COUNT(TARGET) AS 'NUM_OF_CLIENTS'
FROM application
GROUP BY 
	NAME_EDUCATION_TYPE, TARGET 
ORDER BY 
	NAME_EDUCATION_TYPE, 
	NUM_OF_CLIENTS DESC

  
### TASK 8 : Is the number of other loans affecting the payment difficulties? ###
●	You will need to count the number of loans for each SK_ID_CURR in the “bureau” table.
●	Transform the counts into count groups (Discretization).
●	Compute the relation between average other loan count to the TARGET 

# To count the number of loans for each SK_ID_CURR

SELECT 
  SK_ID_CURR, 
  COUNT(SK_ID_CURR) AS "NUM_OF_LOAN"
FROM bureau
GROUP BY SK_ID_CURR

# TO ANALYZE the relation between the loan count to the TARGET

WITH TEMP_TABLE AS (
  SELECT SK_ID_CURR, COUNT(SK_ID_CURR) AS "NUM_OF_LOAN"
  FROM bureau
  GROUP BY SK_ID_CURR 
  ORDER BY "NUM_OF_LOAN")

SELECT 
  TEMP_TABLE.NUM_OF_LOAN, 
  COUNT(TEMP_TABLE.SK_ID_CURR) AS "NUM_OF_CLIENT",
	application.TARGET
FROM TEMP_TABLE JOIN application ON TEMP_TABLE.SK_ID_CURR = application.SK_ID_CURR
GROUP BY NUM_OF_LOAN, TARGET
ORDER BY NUM_OF_LOAN

# DISCRETIZATION

WITH TEMP AS (SELECT SK_ID_CURR, COUNT(SK_ID_CURR) AS "NUM_OF_LOAN"
FROM bureau
GROUP BY SK_ID_CURR 
ORDER BY "NUM_OF_LOAN")

SELECT CASE 
	WHEN TEMP.NUM_OF_LOAN <= 10 THEN '10 OR LESS'
	WHEN TEMP.NUM_OF_LOAN > 10 AND TEMP.NUM_OF_LOAN <= 20 THEN '11-20'
	WHEN TEMP.NUM_OF_LOAN > 20 AND TEMP.NUM_OF_LOAN <= 30 THEN '21-30'
	WHEN TEMP.NUM_OF_LOAN > 30 AND TEMP.NUM_OF_LOAN <= 40 THEN '31-40'
	WHEN TEMP.NUM_OF_LOAN > 40 AND TEMP.NUM_OF_LOAN <= 50 THEN '41-50'
	WHEN TEMP.NUM_OF_LOAN > 50 THEN '50 OR MORE'
END AS "NUM_OF_LOANS",
COUNT(TEMP.SK_ID_CURR) AS "NUM_OF_CLIENT",
	application.TARGET
FROM TEMP JOIN application ON TEMP.SK_ID_CURR = application.SK_ID_CURR
GROUP BY NUM_OF_LOANS, TARGET
ORDER BY NUM_OF_LOANS


### TASK 9 : Freestyle ###
# Now, conduct your own research and analysis to see what factors from the “application” and the “bureau” tables are affecting
# The Credit Scores
# The Payment Difficulty

SELECT 
CASE 
	WHEN CREDIT_DAY_OVERDUE <= 15 THEN '1- 15 DAYS'
	WHEN CREDIT_DAY_OVERDUE > 15 AND CREDIT_DAY_OVERDUE <= 30 THEN '16 - 30 DAYS'
	WHEN CREDIT_DAY_OVERDUE > 30 AND CREDIT_DAY_OVERDUE <= 45 THEN '31 - 45 DAYS'
	WHEN CREDIT_DAY_OVERDUE > 45 AND CREDIT_DAY_OVERDUE <= 90 THEN '46 - 90 DAYS'
	WHEN CREDIT_DAY_OVERDUE > 90 AND CREDIT_DAY_OVERDUE <= 365 THEN '91 - 365 DAYS'
	WHEN CREDIT_DAY_OVERDUE > 365 AND CREDIT_DAY_OVERDUE <= 730 THEN 'BETWEEN 1 - 2 YEARS'
	WHEN CREDIT_DAY_OVERDUE > 730 AND CREDIT_DAY_OVERDUE <= 1096 THEN 'BETWEEN 2 -3 YEARS'
	WHEN CREDIT_DAY_OVERDUE > 1096 THEN 'MORE THAN 3 YEARS'
END AS 'CREDIT_DAYS_OVERDUE',
	COUNT(bureau.SK_ID_CURR) as 'NUM_OF_CLIENTS',
	ROUND(AVG(EXT_SOURCE_1),2) AS 'AVG_EXT_SOURCE_1',
	ROUND(AVG(EXT_SOURCE_2),2) AS 'AVG_EXT_SOURCE_2',
	ROUND(AVG(EXT_SOURCE_3),2) AS 'AVG_EXT_SOURCE_3'
FROM bureau
JOIN application 
ON bureau.SK_ID_CURR = application.SK_ID_CURR
WHERE CREDIT_DAY_OVERDUE != 0
GROUP BY CREDIT_DAYS_OVERDUE
ORDER BY CREDIT_DAYS_OVERDUE

# TO ANALYZE IF CREDIT_TYPE HAS SIGNIFICANT EFFECT ON CREDIT SCORES

SELECT CREDIT_TYPE,
	COUNT(bureau.SK_ID_CURR) as 'NUM_OF_CLIENTS',
	ROUND(AVG(EXT_SOURCE_1),2) AS 'AVG_EXT_SOURCE_1',
	ROUND(AVG(EXT_SOURCE_2),2) AS 'AVG_EXT_SOURCE_2',
	ROUND(AVG(EXT_SOURCE_3),2) AS 'AVG_EXT_SOURCE_3'	
FROM bureau JOIN application
ON bureau.SK_ID_CURR = application.SK_ID_CURR 
GROUP BY CREDIT_TYPE

# TO ANALYZE IF THE AMT_CREDIT_SUM_OVERDUE IS A FACTOR FOR CREDIT SCORES

SELECT * FROM bureau
WHERE CREDIT_ACTIVE != 'Closed'

SELECT 
FROM bureau JOIN application
ON bureau.SK_ID_CURR = application.SK_ID_CURR

SELECT AMT_CREDIT_SUM_OVERDUE FROM bureau
WHERE AMT_CREDIT_SUM_OVERDUE != 0
ORDER BY AMT_CREDIT_SUM_OVERDUE 


SELECT MIN(AMT_CREDIT_SUM_OVERDUE), 
MAX(AMT_CREDIT_SUM_OVERDUE),
AVG(AMT_CREDIT_SUM_OVERDUE)
FROM bureau

WHEN CREDIT_DAY_OVERDUE >= 365 AND CREDIT_DAY_OVERDUE < 548 THEN '12 TO 18 MONTHS'
	WHEN CREDIT_DAY_OVERDUE >= 548 AND CREDIT_DAY_OVERDUE < 730 THEN '18 TO 24 MONTHS'
	WHEN CREDIT_DAY_OVERDUE >= 730 AND CREDIT_DAY_OVERDUE < 1095 THEN '24 MONTHS TO 36 MONTHS'
	WHEN CREDIT_DAY_OVERDUE > 1095 THEN 'MORE THAN 3 YEARS'
	
SELECT 
	MIN(CREDIT_DAY_OVERDUE) AS 'MIN_DAY_OVERDUE',
	MAX(CREDIT_DAY_OVERDUE) AS 'MAX_DAY_OVERDUE',
	AVG(CREDIT_DAY_OVERDUE) AS 'AVG_DAY_OVERDUE'
FROM bureau b
